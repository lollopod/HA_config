<style>
	#fsm-graph svg {
		background-color: #efefef;
		border: 1px solid #cccccc;
	}

	#fsm-graph .state-circle {
		fill: #fff;
		stroke: #000;
		fill-opacity: 0.2;
		stroke-opacity: 0;
		cursor: pointer;
	}

	#fsm-graph .state-circle.active {
		fill-opacity: 1;
		stroke-opacity: 1;
	}

	#fsm-graph .state-circle-text {
		fill-opacity: 0.2;
		cursor: pointer;
		pointer-events: none;
	}

	#fsm-graph .state-circle-text.active {
		fill-opacity: 1
	}

	#fsm-graph .transition-line {
		stroke: #000;
	}

	#fsm-graph .transition-curve {
		stroke: #000;
		stroke.width: 1;
		fill: none;
	}

	#fsm-graph .arrow{
		stroke-width:5;
		stroke:#000;
		stroke-dasharray:5, 5;
	}
</style>
<script type="text/javascript" src="stateMachineGraph.js" inline></script>
<script type="text/javascript">

	function drawStateMachine(definitions, width, height) {
		stateMachineGraph(definitions, width, height)
	}

	var  defaultFsm = { 
		"state": {
			"status": "IDLE",
			"data" : { "x": 5 }
		},
		"transitions": {
			"IDLE": {
				"run": "RUNNING"
			},
			"RUNNING": {
				"stop": "IDLE"
			}
		}
	}

	RED.nodes.registerType('finite-state-machine',{
	category: 'function',
	color: '#C7E9C0',
	defaults: {
		name: { value: "" },
		fsmDefinition: { value: JSON.stringify(defaultFsm) },
		sendInitialState : { value : false },
		showTransitionErrors: { value: true }
	},
	inputs:1,
	outputs:3,
	icon: "function.png",
	label: function() {
		return this.name || "finite-state-machine";
	},
	inputLabels: "trigger",
	outputLabels: ["changed", "statusChanged", "dataChanged" ], 
	oneditprepare: function() {

		// create definiton input field
		let definitionInput = $("#node-input-fsmDefinition")
		definitionInput.typedInput({
					default: 'json',
					types: ['json'],
					typeField: $("#node-input-fsmDefinition")
				});
		definitionInput.typedInput( 'value', this.fsmDefinition );

		definitionInput.on("change", function(type, value) {
			try {
                var json = JSON.parse(definitionInput.typedInput('value'));
                $('#fsm-graph').empty();
                setTimeout( function() {
                    drawStateMachine(json, "100%", 500);
                },500)
			} catch (e) {
				//do nothing
			}
		});
	},
	oneditsave: function() {
		return;
	}
	});
</script>

<script type="text/x-red" data-template-name="finite-state-machine">
	<div class="form-row">
	<label for="node-input-name"><i class="icon-tag"></i> Name</label>
	<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row">
	<label for="node-input-fsmDefinition"><i class="icon-tag"></i> FSM</label>
	<input type="text" id="node-input-fsmDefinition" placeholder="Name">
	</div>
	<div class="form-row">
	<label>&nbsp;</label>
	<input type="checkbox" id="node-input-sendInitialState" style="display: inline-block; width: auto; vertical-align: top;">
	<label for="node-input-sendInitialState" style="width: 70%;">Send initial state</label>
	</div>
	<div class="form-row">
	<label>&nbsp;</label>
	<input type="checkbox" id="node-input-showTransitionErrors" style="display: inline-block; width: auto; vertical-align: top;">
	<label for="node-input-showTransitionErrors" style="width: 70%;">Throw transition errors</label>
	</div>
	<div class="form-row">
        <p>left-click: move / right-click: zoom</p>
		<div id="fsm-graph">
        </div>
	</div>
</script>

<script type="text/x-red" data-help-name="finite-state-machine">
	<p>A finite state machine implementation for node red</p>

	<h3>Properties</h3>
		<dl class="message-properties">
			<dt>name<span class="property-type">string</span></dt>
			<dd>The name of the node as displayed in the editor</dd>
			<dt>FSM<span class="property-type">json </span></dt>
			<dd>
	The json object which descibes the state machine.
	It needs to contain the initial state and possible transitions.
	For more information see details below</dd>
			<dt>Send initial state<span class="property-type">boolean </span></dt>
			<dd>Enable to trigger sending the intital state after 100ms after the flow is started.</dd>
			<dt>Show transition errors<span class="property-type">boolean </span></dt>
			<dd>Enable / disable error msgs when triggering actions.</dd>
		</dl>

	<h3>Inputs</h3>
	<dl class="message-properties">
	<dt>topic <span class="property-type">string</span></dt>
	<dd>
		- <i>reset</i> to reset to initial state<br/>
		- <i>[transition]</i> to trigger a state change<br/>
	</dd>
		<dt>payload <span class="property-type">json</span> </dt>
		<dd>
			May contain a json payload, to add to the state output Example: <code>{ "x" : 10.0, y: "test" }</code>
		 </dd>
	</dl>

	<h3>Outputs</h3>
	<ol class="node-ports">
		<p>All outputs output the same data format: a msg, with its payload containing a <i>status</i> and a <i>data</i> object</p>
		<li>changed
			<dl class="message-properties">
				<dt>payload <span class="property-type">json</span></dt>
				<dd>Outputs the new state when there is any change in state.</dd>
			</dl>
        </li>
        <li>statusChanged
			<dl class="message-properties">
				<dt>payload <span class="property-type">json</span></dt>
				<dd>Outputs the new state only when the machine transitioned to a new status.</dd>
			</dl>
        </li>
        <li>dataChanged
			<dl class="message-properties">
				<dt>payload <span class="property-type">json</span></dt>
				<dd>Outputs the new state only when the data object of the state is changed.</dd>
			</dl>
		</li>
	</ol>

	<h3>Details</h3>
	<p>Example json code for FSM:
<pre>{
  "state": {
    "status": "IDLE",
    "data" : { "x": 5 }
  },
  "transitions": {
    "IDLE": {
      "run": "RUNNING"
    },
    "RUNNING": {
      "stop": "IDLE"
    }
  }
}</pre>
	<ul>
		<li><i>state</i> holds the initial state. It needs to contain a <i>status</i> field and might contain a <i>data</i> object</li>
		<li><i>transitions</i> holds the possible states as Keys (the upper case strings). As Values it holds one or more Key-Value Pairs, consisting of the transition (lower case strings) and the resulting state.</li>
		<li>sending a msg with the topic set to the transition to the node, will trigger a state change.</li>
		<li><i>reset</i> is a reserved transition to reset the machine to its initial state, so it cannot be used in the transition table.</li>
	</ul>
	</p>

</script>
